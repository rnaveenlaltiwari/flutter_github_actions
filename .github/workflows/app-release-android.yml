name: Modular reusable workflows

# ------------------------------------------------------------------------------
# 1. Trigger Configuration
# ------------------------------------------------------------------------------
on:
  workflow_dispatch:
    inputs:
      flavor:
        description: "Choose which flavor to build"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - checkcircle
          - favorite
          - star
          - bookmark

# Uncomment these sections to enable triggers on push or pull_request events
#  push:
#    branches:
#      - feature/*
#  pull_request:
#    branches:
#      - production_v2

env:
  FLUTTER_VERSION: 3.24.5
  # Primary Android SDK/Build Tools/Platform versions
  ANDROID_SDK_VER: "35.0.0"
  ANDROID_PLATFORM_VER: "36"
  # Older versions required for compatibility
  ANDROID_SDK_VER_2: "34.0.0"
  ANDROID_PLATFORM_VER_2: "34"
  ANDROID_PLATFORM_VER_3: "31"
  NDK_VER: "29.0.14033849"
  CMD_LINE_TOOL_VERSION: 10406996
  WORKING_DIRECTORY: .
  GRADLE_VERSION: 8.9

jobs:
  # ----------------------------------------------------------
  # JOB 1: Decrypt config & prepare base64 assets + flavor list
  # ----------------------------------------------------------
  prepare:
    uses: ./.github/workflows/reusable/decrypt-config.yml
    with:
      input-flavor: ${{ github.event.inputs.flavor }}
    secrets: inherit

  # ----------------------------------------------------------
  # JOB 2: Setup Flutter, Android, Ruby, Bundler, Gradle caches
  # ----------------------------------------------------------
  setup:
    needs: prepare
    uses: ./.github/workflows/reusable/env-setup.yml
    secrets: inherit

  # ----------------------------------------------------------
  # JOB 3: Build AAB for each flavor via matrix
  # ----------------------------------------------------------
  build:
    needs: [prepare, setup]
    strategy:
      fail-fast: true
      max-parallel: 2
      matrix:
        flavor: ${{ fromJson(needs.prepare.outputs.flavors-json) }}
    uses: ./.github/workflows/reusable/build-flavor.yml
    with:
      flavor: ${{ matrix.flavor }}
      config_b64: ${{ needs.prepare.outputs.config_b64 }}
      signing_b64: ${{ needs.prepare.outputs.signing_b64 }}
      env_b64: ${{ needs.prepare.outputs.env_b64 }}
      play_json_b64: ${{ needs.prepare.outputs.play_json_b64 }}
      keystore_json: ${{ needs.prepare.outputs.keystore_json }}
    secrets: inherit

  # ----------------------------------------------------------
  # JOB 4: Upload to Google Play (uses Fastlane)
  # ----------------------------------------------------------
  upload:
    needs: build
    uses: ./.github/workflows/reusable/upload-play.yml
    with:
      flavor: ${{ needs.build.outputs.flavor }}
    secrets: inherit
